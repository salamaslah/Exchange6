import React, { useState, useEffect } from 'react';
import { View, Text, TextInput, TouchableOpacity, StyleSheet, ScrollView, Alert, SafeAreaView, Image } from 'react-native';
import { useRouter, useFocusEffect } from 'expo-router';
import AsyncStorage from '@react-native-async-storage/async-storage';
import * as ImagePicker from 'expo-image-picker';
import { customerService, transactionService } from '@/lib/supabase';

interface CustomerInfo {
  customer_name: string;
  national_id: string;
  phone_number: string;
  birth_date: string;
  image1_uri?: string;
  image2_uri?: string;
}

export default function CustomerInfoScreen() {
  const [customerInfo, setCustomerInfo] = useState<CustomerInfo>({
    customer_name: '',
    national_id: '',
    phone_number: '',
    birth_date: '',
    image1_uri: '',
    image2_uri: ''
  });
  const [loading, setLoading] = useState(false);
  const [searching, setSearching] = useState(false);
  const [customerFound, setCustomerFound] = useState(false);
  const [language, setLanguage] = useState<'ar' | 'he' | 'en'>('ar');
  const [selectedService, setSelectedService] = useState<any>(null);
  const [fromCalculator, setFromCalculator] = useState(false);
  const [calculatorData, setCalculatorData] = useState<any>(null);
  const [image1, setImage1] = useState<string | null>(null);
  const [image2, setImage2] = useState<string | null>(null);
  const router = useRouter();

  useEffect(() => {
    loadInitialData();
  }, []);

  useFocusEffect(
    React.useCallback(() => {
      console.log('üîÑ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿµŸÅÿ≠ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≤ÿ®ÿßÿ¶ŸÜ - ŸÅÿ≠ÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
      loadLanguage();
    }, [])
  );

  const loadLanguage = async () => {
    try {
      const savedLanguage = await AsyncStorage.getItem('selectedLanguage');
      if (savedLanguage && ['ar', 'he', 'en'].includes(savedLanguage)) {
        setLanguage(savedLanguage as 'ar' | 'he' | 'en');
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©:', savedLanguage);
      }
    } catch (error) {
      console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©:', error);
    }
  };

  const loadInitialData = async () => {
    try {
      console.log('üîÑ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸäÿ©...');
      
      // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©
      await loadLanguage();

      // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ£ŸàŸÑÿßŸã
      setCustomerInfo({
        customer_name: '',
        national_id: '',
        phone_number: '',
        birth_date: '',
        image1_uri: '',
        image2_uri: ''
      });
      setImage1(null);
      setImage2(null);
      setCustomerFound(false);
      setSelectedService(null);
      setFromCalculator(false);
      setCalculatorData(null);

      // ŸÅÿ≠ÿµ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÇÿßÿØŸÖÿßŸã ŸÖŸÜ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©
      const isFromCalculator = await AsyncStorage.getItem('fromCalculator');
      const calculatorTransactionData = await AsyncStorage.getItem('calculatorData');
      
      console.log('üîç ŸÅÿ≠ÿµ ŸÖÿµÿØÿ± ÿßŸÑŸàÿµŸàŸÑ:');
      console.log('- fromCalculator:', isFromCalculator);
      console.log('- calculatorData exists:', !!calculatorTransactionData);
      
      if (isFromCalculator === 'true' && calculatorTransactionData) {
        console.log('üìä ŸÇÿßÿØŸÖ ŸÖŸÜ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©');
        setFromCalculator(true);
        setCalculatorData(JSON.parse(calculatorTransactionData));
        
        // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆÿØŸÖÿ© ŸÉÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ
        const exchangeService = {
          id: '8',
          service_number: 8,
          service_name: 'ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ',
          service_name_he: '◊î◊ó◊ú◊§◊™ ◊õ◊°◊§◊ô◊ù',
          service_name_en: 'Money Exchange'
        };
        setSelectedService(exchangeService);
        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆÿØŸÖÿ©: ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ');
      } else {
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ© ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿÆÿØŸÖÿßÿ™
        const serviceNumber = await AsyncStorage.getItem('selectedServiceNumber');
        const serviceName = await AsyncStorage.getItem('selectedServiceName');
        const serviceNameHe = await AsyncStorage.getItem('selectedServiceNameHe');
        const serviceNameEn = await AsyncStorage.getItem('selectedServiceNameEn');
        
        console.log('üîç ŸÅÿ≠ÿµ ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ© ŸÖŸÜ AsyncStorage:');
        console.log('- selectedServiceNumber:', serviceNumber);
        console.log('- selectedServiceName:', serviceName);
        
        if (serviceNumber && serviceName) {
          const serviceNum = parseInt(serviceNumber);
          console.log('üîÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ¶ŸÜ ÿßŸÑÿÆÿØŸÖÿ© ŸÑŸÑÿ±ŸÇŸÖ:', serviceNum);
          
          const service = {
            id: serviceNum.toString(),
            service_number: serviceNum,
            service_name: serviceName,
            service_name_he: serviceNameHe || getServiceNameInLanguage(serviceNum, 'he'),
            service_name_en: serviceNameEn || getServiceNameInLanguage(serviceNum, 'en')
          };
          setSelectedService(service);
          console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©:', service.service_name);
        } else {
          console.log('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿÆÿØŸÖÿ© ŸÖÿ≠ÿØÿØÿ©');
        }
      }
    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
    }
  };

  const searchCustomerByNationalId = async (nationalId: string) => {
    if (nationalId.length !== 9) {
      setCustomerFound(false);
      return;
    }

    try {
      setSearching(true);
      console.log(`üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ≤ÿ®ŸàŸÜ ÿ®ÿ±ŸÇŸÖ ÿßŸÑŸáŸàŸäÿ©: ${nationalId}`);
      
      const customer = await customerService.getByNationalId(nationalId);
      
      if (customer) {
        console.log(`‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ®ŸàŸÜ: ${customer.customer_name}`);
        
        // ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        setCustomerInfo({
          customer_name: customer.customer_name,
          national_id: customer.national_id,
          phone_number: customer.phone_number || '',
          birth_date: customer.birth_date,
          image1_uri: customer.image1_uri || customerInfo.image1_uri || '',
          image2_uri: customer.image2_uri || customerInfo.image2_uri || ''
        });

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖÿ™ŸàŸÅÿ±ÿ©
        if (customer.image1_uri && customer.image1_uri.trim()) {
          setImage1(customer.image1_uri);
        }
        if (customer.image2_uri && customer.image2_uri.trim()) {
          setImage2(customer.image2_uri);
        }

        setCustomerFound(true);
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ
        Alert.alert(
          language === 'ar' ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ®ŸàŸÜ' : 
          language === 'he' ? '‚úÖ ◊î◊ú◊ß◊ï◊ó ◊†◊û◊¶◊ê' : 
          '‚úÖ Customer Found',
          
          language === 'ar' ? `ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ: ${customer.customer_name}` :
          language === 'he' ? `◊†◊ò◊¢◊†◊ï ◊§◊®◊ò◊ô ◊î◊ú◊ß◊ï◊ó: ${customer.customer_name}` :
          `Customer data loaded: ${customer.customer_name}`
        );
      } else {
        console.log('üìù ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ®ŸàŸÜ');
        setCustomerFound(false);
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπÿØÿß ÿ±ŸÇŸÖ ÿßŸÑŸáŸàŸäÿ©
        setCustomerInfo(prev => ({
          customer_name: '',
          national_id: prev.national_id,
          phone_number: '',
          birth_date: '',
          image1_uri: '',
          image2_uri: ''
        }));
        setImage1(null);
        setImage2(null);
      }
    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ≤ÿ®ŸàŸÜ:', error);
      setCustomerFound(false);
    } finally {
      setSearching(false);
    }
  };

  const handleNationalIdChange = (text: string) => {
    // ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÅŸÇÿ∑
    const numericText = text.replace(/[^0-9]/g, '');
    
    setCustomerInfo(prev => ({ ...prev, national_id: numericText }));
    
    // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ÿ•ŸÉŸÖÿßŸÑ 9 ÿ£ÿ±ŸÇÿßŸÖ
    if (numericText.length === 9) {
      searchCustomerByNationalId(numericText);
    } else {
      setCustomerFound(false);
      setSearching(false);
    }
  };

  const getServiceNameInLanguage = (serviceNumber: number, lang: 'ar' | 'he' | 'en'): string => {
    const serviceNames = {
      1: { ar: 'ÿ•ŸÜÿ¥ÿßÿ° ŸÅŸäÿ≤ÿß', he: '◊ô◊¶◊ô◊®◊™ ◊õ◊®◊ò◊ô◊°', en: 'Create Card' },
      2: { ar: 'ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÑÿÆÿßÿ±ÿ¨', he: '◊î◊¢◊ë◊®◊î ◊ú◊ó◊ï"◊ú', en: 'International Transfer' },
      3: { ar: 'ÿ≥ÿ≠ÿ® ÿ≠ŸàÿßŸÑÿ©', he: '◊û◊©◊ô◊õ◊™ ◊î◊¢◊ë◊®◊î', en: 'Receive Transfer' },
      4: { ar: 'ÿµÿ±ÿßŸÅÿ© ÿ¥ŸäŸÉÿßÿ™', he: '◊§◊ì◊ô◊ï◊ü ◊¶\'◊ß◊ô◊ù', en: 'Check Cashing' },
      5: { ar: 'ÿ™ÿ≠ŸàŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜŸÉ ÿµÿßÿ≠ÿ® ÿßŸÑŸÖÿ≠ŸÑ', he: '◊î◊¢◊ë◊®◊î ◊ú◊ó◊©◊ë◊ï◊ü ◊î◊ë◊†◊ß', en: 'Bank Account Transfer' },
      6: { ar: 'ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑŸÅŸäÿ≤ÿß', he: '◊û◊©◊ô◊õ◊î ◊û◊õ◊®◊ò◊ô◊°', en: 'Card Withdrawal' },
      7: { ar: 'ÿ•ŸäÿØÿßÿπ ŸÅŸä ÿßŸÑŸÅŸäÿ≤ÿß', he: '◊î◊§◊ß◊ì◊î ◊ë◊õ◊®◊ò◊ô◊°', en: 'Card Deposit' },
      8: { ar: 'ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ', he: '◊î◊ó◊ú◊§◊™ ◊õ◊°◊§◊ô◊ù', en: 'Money Exchange' }
    };

    return serviceNames[serviceNumber as keyof typeof serviceNames]?.[lang] || 'ÿÆÿØŸÖÿ© ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅÿ©';
  };

  const getDisplayedServiceName = (): string => {
    if (!selectedService) {
      return language === 'ar' ? 'ÿÆÿØŸÖÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©' :
             language === 'he' ? '◊©◊ô◊®◊ï◊™ ◊ú◊ê ◊û◊ï◊í◊ì◊®' :
             'Service Not Selected';
    }

    return getServiceNameInLanguage(selectedService.service_number, language);
  };

  const getRequiredFields = () => {
    if (!selectedService) return { basic: true, phone: false, images: false };

    const serviceNumber = selectedService.service_number;

    switch (serviceNumber) {
      case 8: // ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ (ŸÖŸÜ ÿßŸÑÿ¢ŸÑÿ© ÿßŸÑÿ≠ÿßÿ≥ÿ®ÿ©)
        return { basic: true, phone: false, images: false };
      
      case 7: // ÿ•ŸäÿØÿßÿπ ŸÅŸä ÿßŸÑŸÅŸäÿ≤ÿß
        return { basic: true, phone: false, images: false };
      
      case 1: // ÿ•ŸÜÿ¥ÿßÿ° ŸÅŸäÿ≤ÿß
      case 2: // ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÑÿÆÿßÿ±ÿ¨
      case 4: // ÿµÿ±ÿßŸÅÿ© ÿ¥ŸäŸÉÿßÿ™
      case 5: // ÿ™ÿ≠ŸàŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜŸÉ
      case 6: // ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑŸÅŸäÿ≤ÿß
        return { basic: true, phone: true, images: true };
      
      case 3: // ÿ≥ÿ≠ÿ® ÿ≠ŸàÿßŸÑÿ©
        return { basic: true, phone: true, images: true };
      
      default:
        return { basic: true, phone: false, images: false };
    }
  };

  const getImage1Label = () => {
    switch (language) {
      case 'he': return '◊™◊û◊ï◊†◊™ ◊™◊¢◊ï◊ì◊™ ◊ñ◊î◊ï◊™';
      case 'en': return 'ID Photo';
      default: return 'ÿµŸàÿ±ÿ© ÿßŸÑŸáŸàŸäÿ©';
    }
  };

  const getImage2Label = () => {
    if (!selectedService) return 'ÿµŸàÿ±ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©';
    
    const serviceNumber = selectedService.service_number;
    
    switch (serviceNumber) {
      case 1: // ÿ•ŸÜÿ¥ÿßÿ° ŸÅŸäÿ≤ÿß
      case 4: // ÿµÿ±ÿßŸÅÿ© ÿ¥ŸäŸÉÿßÿ™
      case 5: // ÿ™ÿ≠ŸàŸäŸÑ ŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜŸÉ
      case 6: // ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑŸÅŸäÿ≤ÿß
        switch (language) {
          case 'he': return '◊™◊û◊ï◊†◊™ ◊®◊ô◊©◊ô◊ï◊ü ◊†◊î◊ô◊í◊î';
          case 'en': return 'Driver License Photo';
          default: return 'ÿµŸàÿ±ÿ© ÿ±ÿÆÿµÿ© ÿßŸÑŸÇŸäÿßÿØÿ©';
        }
      
      case 2: // ÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÑÿÆÿßÿ±ÿ¨
        switch (language) {
          case 'he': return '◊™◊û◊ï◊†◊™ ◊ì◊®◊õ◊ï◊ü ◊î◊†◊û◊¢◊ü';
          case 'en': return 'Recipient Passport Photo';
          default: return 'ÿµŸàÿ±ÿ© ÿ¨Ÿàÿßÿ≤ ÿ≥ŸÅÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑ ÿ•ŸÑŸäŸá';
        }
      
      case 3: // ÿ≥ÿ≠ÿ® ÿ≠ŸàÿßŸÑÿ©
        switch (language) {
          case 'he': return '◊™◊û◊ï◊†◊™ ◊®◊ô◊©◊ô◊ï◊ü ◊†◊î◊ô◊í◊î';
          case 'en': return 'Driver License Photo';
          default: return 'ÿµŸàÿ±ÿ© ÿ±ÿÆÿµÿ© ÿßŸÑŸÇŸäÿßÿØÿ©';
        }
      
      default:
        switch (language) {
          case 'he': return '◊™◊û◊ï◊†◊î ◊†◊ï◊°◊§◊™';
          case 'en': return 'Additional Photo';
          default: return 'ÿµŸàÿ±ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©';
        }
    }
  };

  const pickImage = async (imageNumber: 1 | 2) => {
    try {
      const permissionResult = await ImagePicker.requestMediaLibraryPermissionsAsync();
      
      if (permissionResult.granted === false) {
        Alert.alert(
          language === 'ar' ? 'ÿ•ÿ∞ŸÜ ŸÖÿ∑ŸÑŸàÿ®' : language === 'he' ? '◊†◊ì◊®◊© ◊ê◊ô◊©◊ï◊®' : 'Permission Required',
          language === 'ar' ? 'ŸÜÿ≠ÿ™ÿßÿ¨ ÿ•ÿ∞ŸÜ ŸÑŸÑŸàÿµŸàŸÑ ŸÑŸÑÿµŸàÿ±' : language === 'he' ? '◊ê◊†◊ó◊†◊ï ◊¶◊®◊ô◊õ◊ô◊ù ◊ê◊ô◊©◊ï◊® ◊ú◊í◊ô◊©◊î ◊ú◊™◊û◊ï◊†◊ï◊™' : 'We need permission to access photos'
        );
        return;
      }

      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [4, 3],
        quality: 0.8,
      });

      if (!result.canceled && result.assets[0]) {
        const imageUri = result.assets[0].uri;
        
        if (imageNumber === 1) {
          setImage1(imageUri);
          setCustomerInfo(prev => ({ ...prev, image1_uri: imageUri }));
          console.log('‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ:', imageUri);
        } else {
          setImage2(imageUri);
          setCustomerInfo(prev => ({ ...prev, image2_uri: imageUri }));
          console.log('‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©:', imageUri);
        }
      }
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ©:', error);
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿµŸàÿ±ÿ©' : language === 'he' ? '◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ë◊ë◊ó◊ô◊®◊™ ◊î◊™◊û◊ï◊†◊î' : 'Error occurred while selecting image'
      );
    }
  };

  const removeImage = (imageNumber: 1 | 2) => {
    if (imageNumber === 1) {
      setImage1(null);
      setCustomerInfo(prev => ({ ...prev, image1_uri: '' }));
      console.log('üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ');
    } else {
      setImage2(null);
      setCustomerInfo(prev => ({ ...prev, image2_uri: '' }));
      console.log('üóëÔ∏è ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©');
    }
  };

  const validateCustomerInfo = (): boolean => {
    const requiredFields = getRequiredFields();
    
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    if (!customerInfo.customer_name.trim()) {
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ≤ÿ®ŸàŸÜ' : 
        language === 'he' ? '◊ê◊†◊ê ◊î◊õ◊†◊° ◊©◊ù ◊î◊ú◊ß◊ï◊ó' : 
        'Please enter customer name'
      );
      return false;
    }

    if (!customerInfo.national_id.trim() || customerInfo.national_id.length !== 9) {
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ŸáŸàŸäÿ© ÿµÿ≠Ÿäÿ≠ (9 ÿ£ÿ±ŸÇÿßŸÖ)' : 
        language === 'he' ? '◊ê◊†◊ê ◊î◊õ◊†◊° ◊û◊°◊§◊® ◊ñ◊î◊ï◊™ ◊™◊ß◊ô◊ü (9 ◊°◊§◊®◊ï◊™)' : 
        'Please enter valid ID number (9 digits)'
      );
      return false;
    }

    if (!customerInfo.birth_date.trim()) {
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ' : 
        language === 'he' ? '◊ê◊†◊ê ◊î◊õ◊†◊° ◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î' : 
        'Please enter birth date'
      );
      return false;
    }

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ∑ŸÑŸàÿ®ÿßŸã
    if (requiredFields.phone && !customerInfo.phone_number.trim()) {
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ' : 
        language === 'he' ? '◊ê◊†◊ê ◊î◊õ◊†◊° ◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü' : 
        'Please enter phone number'
      );
      return false;
    }

    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸàÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖÿ∑ŸÑŸàÿ®ÿ©
    if (requiredFields.images) {
      if (!image1) {
        Alert.alert(
          language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
          language === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ÿµŸàÿ±ÿ© ÿßŸÑŸáŸàŸäÿ©' : 
          language === 'he' ? '◊ê◊†◊ê ◊î◊¢◊ú◊î ◊™◊û◊ï◊†◊™ ◊™◊¢◊ï◊ì◊™ ◊ñ◊î◊ï◊™' : 
          'Please upload ID photo'
        );
        return false;
      }

      if (!image2) {
        Alert.alert(
          language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
          language === 'ar' ? `Ÿäÿ±ÿ¨Ÿâ ÿ±ŸÅÿπ ${getImage2Label()}` : 
          language === 'he' ? `◊ê◊†◊ê ◊î◊¢◊ú◊î ${getImage2Label()}` : 
          `Please upload ${getImage2Label()}`
        );
        return false;
      }
    }

    return true;
  };

  const navigateToServiceScreen = async () => {
    if (!selectedService) {
      Alert.alert('ÿÆÿ∑ÿ£', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿÆÿØŸÖÿ©');
      return;
    }

    const serviceNumber = selectedService.service_number;
    console.log(`üîÑ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿÆÿØŸÖÿ© ÿ±ŸÇŸÖ ${serviceNumber}`);

    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ≥ÿ®ÿ©
    switch (serviceNumber) {
      case 1:
        router.push('/services/visa-creation');
        break;
      case 2:
        router.push('/services/transfer');
        break;
      case 3:
        router.push('/services/remittance');
        break;
      case 4:
        router.push('/services/check');
        break;
      case 5:
        router.push('/services/bank');
        break;
      case 6:
        router.push('/services/withdraw');
        break;
      case 7:
        router.push('/services/deposit');
        break;
      case 8:
        router.push('/services/exchange');
        break;
      default:
        Alert.alert('ÿÆÿ∑ÿ£', 'ÿÆÿØŸÖÿ© ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ©');
    }
  };

  const showCalculatorTransactionMessage = () => {
    const fromCurrencyName = calculatorData.fromCurrency === 'ILS' ? 
      (language === 'ar' ? 'ÿ¥ŸäŸÇŸÑ' : language === 'he' ? '◊©◊ß◊ú' : 'Shekel') :
      calculatorData.fromCurrency;
    
    const toCurrencyName = calculatorData.toCurrency === 'ILS' ? 
      (language === 'ar' ? 'ÿ¥ŸäŸÇŸÑ' : language === 'he' ? '◊©◊ß◊ú' : 'Shekel') :
      calculatorData.toCurrency;

    Alert.alert(
      language === 'ar' ? '‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠' : 
      language === 'he' ? '‚úÖ ◊î◊¢◊°◊ß◊î ◊†◊®◊©◊û◊î ◊ë◊î◊¶◊ú◊ó◊î' : 
      '‚úÖ Transaction Recorded Successfully',
      
      language === 'ar' ? 
        `üôè ÿ¥ŸÉÿ±ÿßŸã ŸÑÿßÿÆÿ™Ÿäÿßÿ±ŸÉ ŸÖÿ≠ŸÑŸÜÿß\n\n` +
        `üìã Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ŸÇÿØŸÖ ÿ•ŸÑŸâ ÿßŸÑÿ¥ÿ®ÿßŸÉ ŸàÿßŸÜÿ™ÿ∏ÿßÿ± ÿØŸàÿ±ŸÉ\n\n` +
        `ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©:\n` +
        `ÿßŸÑÿ≤ÿ®ŸàŸÜ: ${customerInfo.customer_name}\n` +
        `ŸÖŸÜ: ${calculatorData.fromAmount} ${fromCurrencyName}\n` +
        `ÿ•ŸÑŸâ: ${calculatorData.toAmount} ${toCurrencyName}\n\n` +
        `‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠` :
      
      language === 'he' ? 
        `üôè ◊™◊ï◊ì◊î ◊©◊ë◊ó◊®◊™ ◊ë◊ó◊†◊ï◊™ ◊©◊ú◊†◊ï\n\n` +
        `üìã ◊ê◊†◊ê ◊§◊†◊î ◊ú◊ì◊ú◊§◊ß ◊ï◊î◊û◊™◊ü ◊ú◊™◊ï◊®◊ö\n\n` +
        `◊§◊®◊ò◊ô ◊î◊¢◊°◊ß◊î:\n` +
        `◊ú◊ß◊ï◊ó: ${customerInfo.customer_name}\n` +
        `◊û: ${calculatorData.fromAmount} ${fromCurrencyName}\n` +
        `◊ú: ${calculatorData.toAmount} ${toCurrencyName}\n\n` +
        `‚úÖ ◊î◊¢◊°◊ß◊î ◊†◊®◊©◊û◊î ◊ë◊û◊¢◊®◊õ◊™ ◊ë◊î◊¶◊ú◊ó◊î` :
      
        `üôè Thank you for choosing our store\n\n` +
        `üìã Please proceed to the counter and wait for your turn\n\n` +
        `Transaction Details:\n` +
        `Customer: ${customerInfo.customer_name}\n` +
        `From: ${calculatorData.fromAmount} ${fromCurrencyName}\n` +
        `To: ${calculatorData.toAmount} ${toCurrencyName}\n\n` +
        `‚úÖ Transaction recorded in system successfully`,
      
      [
        {
          text: language === 'ar' ? 'üè† ÿßŸÑÿπŸàÿØÿ© ŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸäŸàŸÖ' : 
                language === 'he' ? 'üè† ◊ó◊ñ◊®◊î ◊ú◊û◊ó◊ô◊®◊ô ◊î◊ô◊ï◊ù' : 
                'üè† Back to Today\'s Prices',
          onPress: () => router.replace('/(tabs)/prices')
        }
      ]
    );
  };

  const handleContinue = async () => {
    if (!validateCustomerInfo()) return;

    try {
      setLoading(true);
      console.log('üîÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ...');

      // ÿ≠ŸÅÿ∏ ŸÖÿπÿ±ŸÅ ÿßŸÑÿ≤ÿ®ŸàŸÜ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä
      await AsyncStorage.setItem('currentCustomerId', customerInfo.national_id);
      await AsyncStorage.setItem('currentCustomerName', customerInfo.customer_name);
      await AsyncStorage.setItem('currentCustomerPhone', customerInfo.phone_number);
      await AsyncStorage.setItem('currentCustomerBirthDate', customerInfo.birth_date);
      
      if (image1) {
        await AsyncStorage.setItem('currentCustomerImage1', image1);
      }
      if (image2) {
        await AsyncStorage.setItem('currentCustomerImage2', image2);
      }
      
      console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÅŸä ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä');

      // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿÆÿØŸÖÿ©
      if (fromCalculator && calculatorData) {
        // ÿ•ŸÜÿ¥ÿßÿ° ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        try {
          const existingCustomer = await customerService.getByNationalId(customerInfo.national_id);
          
          if (existingCustomer) {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
            await customerService.update(existingCustomer.id, {
              customer_name: customerInfo.customer_name,
              phone_number: customerInfo.phone_number,
              birth_date: customerInfo.birth_date,
              image1_uri: image1 || '',
              image2_uri: image2 || ''
            });
            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
          } else {
            // ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ®ŸàŸÜ ÿ¨ÿØŸäÿØ
            await customerService.create({
              customer_name: customerInfo.customer_name,
              national_id: customerInfo.national_id,
              phone_number: customerInfo.phone_number,
              birth_date: customerInfo.birth_date,
              image1_uri: image1 || '',
              image2_uri: image2 || ''
            });
            console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ®ŸàŸÜ ÿ¨ÿØŸäÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
          }
        } catch (customerError) {
          console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', customerError);
          // ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≤ÿ®ŸàŸÜ
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿßŸÖŸÑÿ© ÿµÿ±ÿßŸÅÿ© ÿßŸÑÿ£ŸÖŸàÿßŸÑ ŸÅŸä ÿ¨ÿØŸàŸÑ transactions
        try {
          const transactionData = {
            service_number: 8, // ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ
            amount_paid: parseFloat(calculatorData.fromAmount),
            currency_paid: calculatorData.fromCurrency,
            amount_received: parseFloat(calculatorData.toAmount),
            currency_received: calculatorData.toCurrency,
            customer_id: customerInfo.national_id,
            notes: `ŸÖÿπÿßŸÖŸÑÿ© ÿµÿ±ÿßŸÅÿ© ÿ£ŸÖŸàÿßŸÑ - ÿßŸÑÿ≤ÿ®ŸàŸÜ: ${customerInfo.customer_name}`
          };
          
          console.log('üîÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿßŸÖŸÑÿ© ÿµÿ±ÿßŸÅÿ© ÿßŸÑÿ£ŸÖŸàÿßŸÑ ŸÅŸä ÿ¨ÿØŸàŸÑ transactions:', transactionData);
          
          // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ÿ•ŸÑŸâ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          await transactionService.create(transactionData);
          
          console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿπÿßŸÖŸÑÿ© ÿµÿ±ÿßŸÅÿ© ÿßŸÑÿ£ŸÖŸàÿßŸÑ ŸÅŸä ÿ¨ÿØŸàŸÑ transactions ÿ®ŸÜÿ¨ÿßÿ≠');
        } catch (transactionError) {
          console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', transactionError);
          // ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©
        }

        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©
        await AsyncStorage.removeItem('fromCalculator');
        await AsyncStorage.removeItem('calculatorData');
        
        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ¥ŸÉÿ± ŸàÿßŸÑÿ™Ÿàÿ¨ŸäŸá
        showCalculatorTransactionMessage();
      } else {
        await navigateToServiceScreen();
      }

    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ:', error);
      Alert.alert(
        language === 'ar' ? 'ÿÆÿ∑ÿ£' : language === 'he' ? '◊©◊í◊ô◊ê◊î' : 'Error',
        language === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™' : 
        language === 'he' ? '◊ê◊ô◊®◊¢◊î ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ô◊ë◊ï◊ì ◊î◊†◊™◊ï◊†◊ô◊ù' : 
        'Error occurred while processing data'
      );
    } finally {
      setLoading(false);
    }
  };

  const handleBack = () => {
    router.back();
  };

  const getTextAlign = () => {
    return language === 'en' ? 'left' : 'right';
  };

  const getNationalIdInputStyle = () => {
    if (searching) {
      return [styles.input, styles.searchingInput, { textAlign: 'center' }];
    } else if (customerFound) {
      return [styles.input, styles.foundInput, { textAlign: 'center' }];
    } else {
      return [styles.input, { textAlign: 'center' }];
    }
  };

  const getNationalIdPlaceholder = () => {
    if (searching) {
      return language === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...' : 
             language === 'he' ? '◊û◊ó◊§◊©...' : 
             'Searching...';
    } else if (customerFound) {
      return language === 'ar' ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ®ŸàŸÜ' : 
             language === 'he' ? '‚úÖ ◊î◊ú◊ß◊ï◊ó ◊†◊û◊¶◊ê' : 
             '‚úÖ Customer Found';
    } else {
      return '123456789';
    }
  };

  const requiredFields = getRequiredFields();

  return (
    <SafeAreaView style={styles.container}>
      <ScrollView 
        style={styles.scrollContainer}
        showsVerticalScrollIndicator={false}
        showsHorizontalScrollIndicator={false}
      >
        <View style={styles.header}>
          <TouchableOpacity style={styles.backButton} onPress={handleBack}>
            <Text style={styles.backButtonText}>
              {language === 'ar' && '‚Üê ÿßŸÑÿπŸàÿØÿ©'}
              {language === 'he' && '‚Üê ◊ó◊ñ◊®◊î'}
              {language === 'en' && '‚Üê Back'}
            </Text>
          </TouchableOpacity>
          
          <Text style={styles.title}>
            {language === 'ar' && 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≤ÿ®ŸàŸÜ'}
            {language === 'he' && '◊§◊®◊ò◊ô ◊î◊ú◊ß◊ï◊ó'}
            {language === 'en' && 'Customer Information'}
          </Text>
          
          <View style={{ width: 80 }} />
        </View>

        <View style={styles.content}>
          {/* Selected Service Display */}
          <View style={styles.selectedServiceContainer}>
            <Text style={[styles.selectedServiceLabel, { textAlign: getTextAlign() }]}>
              {language === 'ar' && 'ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©:'}
              {language === 'he' && '◊î◊©◊ô◊®◊ï◊™ ◊î◊†◊ë◊ó◊®:'}
              {language === 'en' && 'Selected Service:'}
            </Text>
            <Text style={[styles.selectedServiceName, { textAlign: getTextAlign() }]}>
              {getDisplayedServiceName()}
            </Text>
          </View>

          {/* Customer Information Form */}
          <View style={styles.formContainer}>
            <Text style={[styles.sectionTitle, { textAlign: getTextAlign() }]}>
              {language === 'ar' && 'ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©:'}
              {language === 'he' && '◊§◊®◊ò◊ô◊ù ◊ë◊°◊ô◊°◊ô◊ô◊ù:'}
              {language === 'en' && 'Basic Information:'}
            </Text>

            {/* National ID with Auto Search */}
            <View style={styles.inputGroup}>
              <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                {language === 'ar' && 'ÿ±ŸÇŸÖ ÿßŸÑŸáŸàŸäÿ© (9 ÿ£ÿ±ŸÇÿßŸÖ):'}
                {language === 'he' && '◊û◊°◊§◊® ◊ñ◊î◊ï◊™ (9 ◊°◊§◊®◊ï◊™):'}
                {language === 'en' && 'National ID (9 digits):'}
              </Text>
              <TextInput
                style={getNationalIdInputStyle()}
                value={customerInfo.national_id}
                onChangeText={handleNationalIdChange}
                placeholder={getNationalIdPlaceholder()}
                keyboardType="numeric"
                maxLength={9}
                editable={!searching}
              />
              {searching && (
                <Text style={[styles.searchingText, { textAlign: getTextAlign() }]}>
                  {language === 'ar' && 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...'}
                  {language === 'he' && '◊û◊ó◊§◊© ◊ë◊û◊°◊ì ◊î◊†◊™◊ï◊†◊ô◊ù...'}
                  {language === 'en' && 'Searching in database...'}
                </Text>
              )}
              {customerFound && (
                <Text style={[styles.foundText, { textAlign: getTextAlign() }]}>
                  {language === 'ar' && '‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ®ŸàŸÜ Ÿàÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™Ÿá'}
                  {language === 'he' && '‚úÖ ◊î◊ú◊ß◊ï◊ó ◊†◊û◊¶◊ê ◊ï◊î◊†◊™◊ï◊†◊ô◊ù ◊†◊ò◊¢◊†◊ï'}
                  {language === 'en' && '‚úÖ Customer found and data loaded'}
                </Text>
              )}
            </View>

            {/* Customer Name */}
            <View style={styles.inputGroup}>
              <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                {language === 'ar' && 'ÿßÿ≥ŸÖ ÿßŸÑÿ≤ÿ®ŸàŸÜ:'}
                {language === 'he' && '◊©◊ù ◊î◊ú◊ß◊ï◊ó:'}
                {language === 'en' && 'Customer Name:'}
              </Text>
              <TextInput
                style={[
                  styles.input, 
                  customerFound && styles.foundInput,
                  { textAlign: getTextAlign() }
                ]}
                value={customerInfo.customer_name}
                onChangeText={(text) => setCustomerInfo(prev => ({ ...prev, customer_name: text }))}
                placeholder={
                  language === 'ar' ? 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ' :
                  language === 'he' ? '◊ê◊ó◊û◊ì ◊û◊ï◊ó◊û◊ì' :
                  'Ahmad Mohammad'
                }
                editable={!customerFound}
              />
            </View>

            {/* Birth Date */}
            <View style={styles.inputGroup}>
              <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                {language === 'ar' && 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:'}
                {language === 'he' && '◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î:'}
                {language === 'en' && 'Birth Date:'}
              </Text>
              <TextInput
                style={[
                  styles.input, 
                  customerFound && styles.foundInput,
                  { textAlign: 'center' }
                ]}
                value={customerInfo.birth_date}
                onChangeText={(text) => setCustomerInfo(prev => ({ ...prev, birth_date: text }))}
                placeholder="1990-01-01"
                editable={!customerFound}
              />
            </View>

            {/* Phone Number (if required) */}
            {requiredFields.phone && (
              <View style={styles.inputGroup}>
                <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                  {language === 'ar' && 'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:'}
                  {language === 'he' && '◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü:'}
                  {language === 'en' && 'Phone Number:'}
                </Text>
                <TextInput
                  style={[
                    styles.input,
                    customerFound && customerInfo.phone_number ? styles.foundInput : styles.input,
                    { textAlign: 'center' }
                  ]}
                  value={customerInfo.phone_number}
                  onChangeText={(text) => setCustomerInfo(prev => ({ ...prev, phone_number: text }))}
                  placeholder="0501234567"
                  keyboardType="phone-pad"
                  editable={true}
                />
              </View>
            )}

            {/* Image 1 (if required) */}
            {requiredFields.images && (
              <View style={styles.inputGroup}>
                <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                  {getImage1Label()}:
                </Text>
                
                {image1 ? (
                  <View style={styles.imageContainer}>
                    <Image source={{ uri: image1 }} style={styles.uploadedImage} />
                    {!customerFound && (
                      <View style={styles.imageActions}>
                        <TouchableOpacity 
                          style={styles.changeImageButton}
                          onPress={() => pickImage(1)}
                        >
                          <Text style={styles.changeImageButtonText}>
                            {language === 'ar' && 'ÿ™ÿ∫ŸäŸäÿ±'}
                            {language === 'he' && '◊©◊†◊î'}
                            {language === 'en' && 'Change'}
                          </Text>
                        </TouchableOpacity>
                        <TouchableOpacity 
                          style={styles.removeImageButton}
                          onPress={() => removeImage(1)}
                        >
                          <Text style={styles.removeImageButtonText}>
                            {language === 'ar' && 'ÿ≠ÿ∞ŸÅ'}
                            {language === 'he' && '◊û◊ó◊ß'}
                            {language === 'en' && 'Remove'}
                          </Text>
                        </TouchableOpacity>
                      </View>
                    )}
                    {customerFound && (
                      <Text style={[styles.imageLoadedText, { textAlign: getTextAlign() }]}>
                        {language === 'ar' && '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}
                        {language === 'he' && '‚úÖ ◊î◊™◊û◊ï◊†◊î ◊†◊ò◊¢◊†◊î ◊û◊û◊°◊ì ◊î◊†◊™◊ï◊†◊ô◊ù'}
                        {language === 'en' && '‚úÖ Image loaded from database'}
                      </Text>
                    )}
                  </View>
                ) : (
                  <TouchableOpacity 
                    style={styles.uploadButton}
                    onPress={() => pickImage(1)}
                  >
                    <Text style={styles.uploadButtonIcon}>üì∑</Text>
                    <Text style={[styles.uploadButtonText, { textAlign: getTextAlign() }]}>
                      {language === 'ar' && `ÿßÿÆÿ™Ÿäÿßÿ± ${getImage1Label()}`}
                      {language === 'he' && `◊ë◊ó◊® ${getImage1Label()}`}
                      {language === 'en' && `Select ${getImage1Label()}`}
                    </Text>
                  </TouchableOpacity>
                )}
                
                {/* ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ© */}
                {customerFound && !image1 && (
                  <Text style={[styles.missingDataText, { textAlign: getTextAlign() }]}>
                    {language === 'ar' && '‚ö†Ô∏è ÿßŸÑÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© - ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß'}
                    {language === 'he' && '‚ö†Ô∏è ◊î◊™◊û◊ï◊†◊î ◊ó◊°◊®◊î - ◊†◊ô◊™◊ü ◊ú◊î◊ï◊°◊ô◊£'}
                    {language === 'en' && '‚ö†Ô∏è Image missing - you can add it'}
                  </Text>
                )}
              </View>
            )}

            {/* Image 2 (if required) */}
            {requiredFields.images && (
              <View style={styles.inputGroup}>
                <Text style={[styles.inputLabel, { textAlign: getTextAlign() }]}>
                  {getImage2Label()}:
                </Text>
                
                {image2 ? (
                  <View style={styles.imageContainer}>
                    <Image source={{ uri: image2 }} style={styles.uploadedImage} />
                    {!customerFound && (
                      <View style={styles.imageActions}>
                        <TouchableOpacity 
                          style={styles.changeImageButton}
                          onPress={() => pickImage(2)}
                        >
                          <Text style={styles.changeImageButtonText}>
                            {language === 'ar' && 'ÿ™ÿ∫ŸäŸäÿ±'}
                            {language === 'he' && '◊©◊†◊î'}
                            {language === 'en' && 'Change'}
                          </Text>
                        </TouchableOpacity>
                        <TouchableOpacity 
                          style={styles.removeImageButton}
                          onPress={() => removeImage(2)}
                        >
                          <Text style={styles.removeImageButtonText}>
                            {language === 'ar' && 'ÿ≠ÿ∞ŸÅ'}
                            {language === 'he' && '◊û◊ó◊ß'}
                            {language === 'en' && 'Remove'}
                          </Text>
                        </TouchableOpacity>
                      </View>
                    )}
                    {customerFound && (
                      <Text style={[styles.imageLoadedText, { textAlign: getTextAlign() }]}>
                        {language === 'ar' && '‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}
                        {language === 'he' && '‚úÖ ◊î◊™◊û◊ï◊†◊î ◊†◊ò◊¢◊†◊î ◊û◊û◊°◊ì ◊î◊†◊™◊ï◊†◊ô◊ù'}
                        {language === 'en' && '‚úÖ Image loaded from database'}
                      </Text>
                    )}
                  </View>
                ) : (
                  <TouchableOpacity 
                    style={styles.uploadButton}
                    onPress={() => pickImage(2)}
                  >
                    <Text style={styles.uploadButtonIcon}>üìÑ</Text>
                    <Text style={[styles.uploadButtonText, { textAlign: getTextAlign() }]}>
                      {language === 'ar' && `ÿßÿÆÿ™Ÿäÿßÿ± ${getImage2Label()}`}
                      {language === 'he' && `◊ë◊ó◊® ${getImage2Label()}`}
                      {language === 'en' && `Select ${getImage2Label()}`}
                    </Text>
                  </TouchableOpacity>
                )}
                
                {/* ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ© */}
                {customerFound && !image2 && (
                  <Text style={[styles.missingDataText, { textAlign: getTextAlign() }]}>
                    {language === 'ar' && '‚ö†Ô∏è ÿßŸÑÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© - ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß'}
                    {language === 'he' && '‚ö†Ô∏è ◊î◊™◊û◊ï◊†◊î ◊ó◊°◊®◊î - ◊†◊ô◊™◊ü ◊ú◊î◊ï◊°◊ô◊£'}
                    {language === 'en' && '‚ö†Ô∏è Image missing - you can add it'}
                  </Text>
                )}
              </View>
            )}

            {/* Continue Button */}
            <TouchableOpacity 
              style={[styles.continueButton, loading && styles.disabledButton]} 
              onPress={handleContinue}
              disabled={loading}
            >
              <Text style={styles.continueButtonText}>
                {loading ? (
                  language === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...' :
                  language === 'he' ? '◊û◊¢◊ë◊ì...' :
                  'Processing...'
                ) : (
                  language === 'ar' ? '‚úÖ ŸÖÿ™ÿßÿ®ÿπÿ©' :
                  language === 'he' ? '‚úÖ ◊î◊û◊©◊ö' :
                  '‚úÖ Continue'
                )}
              </Text>
            </TouchableOpacity>
          </View>

          {/* Information Section */}
          <View style={styles.infoContainer}>
            <Text style={[styles.infoTitle, { textAlign: getTextAlign() }]}>
              {language === 'ar' && '‚ÑπÔ∏è ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ∑ŸÑŸàÿ®ÿ©:'}
              {language === 'he' && '‚ÑπÔ∏è ◊û◊ô◊ì◊¢ ◊†◊ì◊®◊©:'}
              {language === 'en' && '‚ÑπÔ∏è Required Information:'}
            </Text>
            <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
              {language === 'ar' && '‚Ä¢ ÿ±ŸÇŸÖ ÿßŸÑŸáŸàŸäÿ© (9 ÿ£ÿ±ŸÇÿßŸÖ) - ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä'}
              {language === 'he' && '‚Ä¢ ◊û◊°◊§◊® ◊ñ◊î◊ï◊™ (9 ◊°◊§◊®◊ï◊™) - ◊ó◊ô◊§◊ï◊© ◊ê◊ï◊ò◊ï◊û◊ò◊ô'}
              {language === 'en' && '‚Ä¢ National ID (9 digits) - Auto search'}
            </Text>
            <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
              {language === 'ar' && '‚Ä¢ ÿßÿ≥ŸÖ ÿßŸÑÿ≤ÿ®ŸàŸÜ ÿßŸÑŸÉÿßŸÖŸÑ'}
              {language === 'he' && '‚Ä¢ ◊©◊ù ◊î◊ú◊ß◊ï◊ó ◊î◊û◊ú◊ê'}
              {language === 'en' && '‚Ä¢ Full customer name'}
            </Text>
            <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
              {language === 'ar' && '‚Ä¢ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ'}
              {language === 'he' && '‚Ä¢ ◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î'}
              {language === 'en' && '‚Ä¢ Birth date'}
            </Text>
            {requiredFields.phone && (
              <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
                {language === 'ar' && '‚Ä¢ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ'}
                {language === 'he' && '‚Ä¢ ◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü'}
                {language === 'en' && '‚Ä¢ Phone number'}
              </Text>
            )}
            {requiredFields.images && (
              <>
                <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
                  {language === 'ar' && `‚Ä¢ ${getImage1Label()}`}
                  {language === 'he' && `‚Ä¢ ${getImage1Label()}`}
                  {language === 'en' && `‚Ä¢ ${getImage1Label()}`}
                </Text>
                <Text style={[styles.infoText, { textAlign: getTextAlign() }]}>
                  {language === 'ar' && `‚Ä¢ ${getImage2Label()}`}
                  {language === 'he' && `‚Ä¢ ${getImage2Label()}`}
                  {language === 'en' && `‚Ä¢ ${getImage2Label()}`}
                </Text>
              </>
            )}
          </View>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F0F9FF',
  },
  scrollContainer: {
    flex: 1,
    padding: 20,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 30,
    marginTop: 20,
  },
  backButton: {
    backgroundColor: '#6B7280',
    paddingHorizontal: 15,
    paddingVertical: 8,
    borderRadius: 6,
    width: 80,
  },
  backButtonText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#0369A1',
    textAlign: 'center',
    flex: 1,
  },
  content: {
    flex: 1,
  },
  selectedServiceContainer: {
    backgroundColor: '#EFF6FF',
    padding: 15,
    borderRadius: 12,
    marginBottom: 20,
    borderLeftWidth: 4,
    borderLeftColor: '#3B82F6',
  },
  selectedServiceLabel: {
    fontSize: 14,
    color: '#1E40AF',
    fontWeight: '600',
    marginBottom: 5,
  },
  selectedServiceName: {
    fontSize: 18,
    color: '#1E40AF',
    fontWeight: 'bold',
  },
  formContainer: {
    backgroundColor: '#FFFFFF',
    borderRadius: 16,
    padding: 25,
    marginBottom: 20,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 8,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#1F2937',
    marginBottom: 20,
    backgroundColor: '#F3F4F6',
    padding: 12,
    borderRadius: 8,
  },
  inputGroup: {
    marginBottom: 20,
  },
  inputLabel: {
    fontSize: 16,
    color: '#374151',
    marginBottom: 8,
    fontWeight: '600',
  },
  input: {
    borderWidth: 2,
    borderColor: '#D1D5DB',
    padding: 15,
    fontSize: 16,
    borderRadius: 8,
    backgroundColor: '#F9FAFB',
    color: '#1F2937',
  },
  searchingInput: {
    borderColor: '#F59E0B',
    backgroundColor: '#FEF3C7',
  },
  foundInput: {
    borderColor: '#059669',
    backgroundColor: '#ECFDF5',
  },
  searchingText: {
    fontSize: 12,
    color: '#92400E',
    marginTop: 5,
    fontStyle: 'italic',
  },
  foundText: {
    fontSize: 12,
    color: '#065F46',
    marginTop: 5,
    fontWeight: '600',
  },
  imageLoadedText: {
    fontSize: 12,
    color: '#065F46',
    marginTop: 8,
    fontWeight: '600',
  },
  continueButton: {
    backgroundColor: '#0369A1',
    padding: 18,
    borderRadius: 12,
    alignItems: 'center',
    marginTop: 10,
    shadowColor: '#0369A1',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
  },
  disabledButton: {
    backgroundColor: '#9CA3AF',
    shadowOpacity: 0,
    elevation: 0,
  },
  continueButtonText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontWeight: 'bold',
  },
  infoContainer: {
    backgroundColor: '#FEF3C7',
    padding: 20,
    borderRadius: 12,
    borderLeftWidth: 4,
    borderLeftColor: '#F59E0B',
  },
  infoTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#92400E',
    marginBottom: 10,
  },
  infoText: {
    fontSize: 14,
    color: '#92400E',
    marginBottom: 8,
    lineHeight: 20,
  },
  // Image Upload Styles
  uploadButton: {
    borderWidth: 2,
    borderColor: '#D1D5DB',
    borderStyle: 'dashed',
    borderRadius: 8,
    backgroundColor: '#F9FAFB',
    padding: 20,
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 100,
  },
  uploadButtonIcon: {
    fontSize: 32,
    marginBottom: 8,
  },
  uploadButtonText: {
    fontSize: 14,
    color: '#6B7280',
    fontWeight: '600',
  },
  imageContainer: {
    alignItems: 'center',
  },
  uploadedImage: {
    width: 200,
    height: 150,
    borderRadius: 8,
    marginBottom: 10,
  },
  imageActions: {
    flexDirection: 'row',
    gap: 10,
  },
  changeImageButton: {
    backgroundColor: '#3B82F6',
    paddingHorizontal: 15,
    paddingVertical: 8,
    borderRadius: 6,
  },
  changeImageButtonText: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: 'bold',
  },
  removeImageButton: {
    backgroundColor: '#DC2626',
    paddingHorizontal: 15,
    paddingVertical: 8,
    borderRadius: 6,
  },
  removeImageButtonText: {
    color: '#FFFFFF',
    fontSize: 12,
    fontWeight: 'bold',
  },
  missingDataText: {
    fontSize: 12,
    color: '#DC2626',
    marginTop: 8,
    fontStyle: 'italic',
  },
});